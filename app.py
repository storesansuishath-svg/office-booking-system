import streamlit as st
import pandas as pd
from supabase import create_client
from datetime import datetime, timedelta
import requests
import json

# --- 1. ‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Supabase ---
SUPABASE_URL = "https://qejqynbxdflwebzzwfzu.supabase.co" 
SUPABASE_KEY = "sb_publishable_hvNQEPvuEAlXfVeCzpy7Ug_kzvihQqq"
supabase = create_client(SUPABASE_URL, SUPABASE_KEY)

# ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô LINE
def send_line_notification(booking_id, resource, name, dept, t_start, t_end, purpose, destination, status_text="‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠‡πÉ‡∏´‡∏°‡πà"):
    render_url = "https://line-booking-system.onrender.com/notify"
    
    start_str = t_start.strftime("%d/%m/%Y %H:%M") if isinstance(t_start, datetime) else t_start
    end_str = t_end.strftime("%H:%M") if isinstance(t_end, datetime) else t_end

    payload = {
        "id": booking_id,
        "resource": resource,
        "name": name,
        "dept": dept,
        "date": start_str,
        "end_date": end_str,
        "purpose": f"[{status_text}] {purpose}" 
    }
    
    try:
        requests.post(render_url, json=payload, timeout=5)
    except:
        pass

# --- 2. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ (‡∏à‡∏ö‡∏á‡∏≤‡∏ô‡πÄ‡∏Å‡∏¥‡∏ô 24 ‡∏ä‡∏°.) ---
def auto_delete_old_bookings():
    threshold_time = (datetime.now() - timedelta(hours=24)).isoformat()
    try:
        supabase.table("bookings").delete().lt("end_time", threshold_time).execute()
    except:
        pass

# --- 3. ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡πÅ‡∏•‡∏∞ Sidebar ---
st.set_page_config(page_title="‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏≠‡∏á‡∏£‡∏ñ & ‡∏´‡πâ‡∏≠‡∏á‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°", layout="wide")
LOGO_URL = "https://lh3.googleusercontent.com/d/1zCjSjSbCO-mbsaGoDI6g0G-bfmyVfqFV"
st.sidebar.image(LOGO_URL, use_container_width=True)
st.sidebar.markdown("---")

auto_delete_old_bookings()

st.title("‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏≠‡∏á‡∏£‡∏ñ‡∏¢‡∏ô‡∏ï‡πå‡πÅ‡∏•‡∏∞‡∏´‡πâ‡∏≠‡∏á‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏° Online")
menu = ["üìù ‡∏à‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà", "üìÖ ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏á‡∏≤‡∏ô (Real-time)", "üîë Admin (‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥)"]
choice = st.sidebar.selectbox("‡πÄ‡∏°‡∏ô‡∏π", menu)

# --- ‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà ---
if choice == "üìù ‡∏à‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà":
    st.subheader("‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á")
    col1, col2 = st.columns(2)
    with col1:
        cat = st.radio("‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏ó‡∏£‡∏±‡∏û‡∏¢‡∏≤‡∏Å‡∏£", ["‡∏£‡∏ñ‡∏¢‡∏ô‡∏ï‡πå", "‡∏´‡πâ‡∏≠‡∏á‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°"])
        if cat == "‡∏£‡∏ñ‡∏¢‡∏ô‡∏ï‡πå":
            res = st.selectbox("‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏±‡∏ô", ["Civic (‡∏ï‡∏∏‡πâ‡∏°)", "Civic (‡∏ö‡∏≠‡∏•)", "Camry (‡πÄ‡∏ô‡∏Å)", "MG ‡∏Ç‡∏±‡∏ö‡πÄ‡∏≠‡∏á"])
            destination = st.text_input("‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á", placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó ABC")
        else:
            res = st.selectbox("‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡πâ‡∏≠‡∏á", ["‡∏´‡πâ‡∏≠‡∏á‡∏ä‡∏±‡πâ‡∏ô 1 (‡∏´‡πâ‡∏≠‡∏á‡πÉ‡∏´‡∏ç‡πà)", "‡∏´‡πâ‡∏≠‡∏á‡∏ä‡∏±‡πâ‡∏ô 2", "‡∏´‡πâ‡∏≠‡∏á VIP", "‡∏´‡πâ‡∏≠‡∏á‡∏ä‡∏±‡πâ‡∏ô‡∏•‡∏≠‡∏¢", "‡∏´‡πâ‡∏≠‡∏á Production"])
            destination = "Office"
        name = st.text_input("‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏à‡∏≠‡∏á")
        phone = st.text_input("‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå")
        dept = st.text_input("‡πÅ‡∏ú‡∏ô‡∏Å")
    with col2:
        t_start = st.datetime_input("‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°", datetime.now())
        t_end = st.datetime_input("‡πÄ‡∏ß‡∏•‡∏≤‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î", datetime.now() + timedelta(hours=1))
        reason = st.text_area("‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏õ‡∏£‡∏∞‡∏™‡∏á‡∏Ñ‡πå‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô")

    if st.button("‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏à‡∏≠‡∏á"):
        if not name or not phone or not reason or not dept:
            st.warning("‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô")
        elif t_start < (datetime.now() - timedelta(minutes=5)):
            st.error("‚ùå ‡∏´‡πâ‡∏≤‡∏°‡∏à‡∏≠‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á")
        elif t_start >= t_end:
            st.error("‚ùå ‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏ß‡∏•‡∏≤‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î")
        else:
            check_res = supabase.table("bookings").select("*").eq("resource", res).eq("status", "Approved").execute()
            df_check = pd.DataFrame(check_res.data)
            is_overlap = False
            if not df_check.empty:
                df_check['start_time'] = pd.to_datetime(df_check['start_time']).dt.tz_localize(None)
                df_check['end_time'] = pd.to_datetime(df_check['end_time']).dt.tz_localize(None)
                overlap = df_check[~((df_check['start_time'] >= t_end) | (df_check['end_time'] <= t_start))]
                if not overlap.empty: is_overlap = True

            if is_overlap:
                st.error(f"‚ùå ‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏á: {res} ‡∏ñ‡∏π‡∏Å‡∏à‡∏≠‡∏á‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏ô‡∏µ‡πâ")
            else:
                data = {"resource": res, "requester": name, "phone": phone, "dept": dept, 
                        "start_time": t_start.isoformat(), "end_time": t_end.isoformat(),
