import streamlit as st
import pandas as pd
from supabase import create_client
from datetime import datetime, timedelta
import requests
import json
import io

# --- 1. ‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Supabase ---
SUPABASE_URL = "https://qejqynbxdflwebzzwfzu.supabase.co" 
SUPABASE_KEY = "sb_publishable_hvNQEPvuEAlXfVeCzpy7Ug_kzvihQqq"
supabase = create_client(SUPABASE_URL, SUPABASE_KEY)

# ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ä‡πà‡∏ß‡∏¢‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÄ‡∏ß‡∏•‡∏≤ (0800 -> 08:00)
def format_time_string(t_raw):
    clean = str(t_raw).replace(":", "").strip()
    if len(clean) == 4:
        return f"{clean[:2]}:{clean[2:]}"
    return clean

def send_line_notification(booking_id, resource, name, dept, t_start, t_end, purpose, destination, status_text="Pending"):
    render_url = "https://line-booking-system.onrender.com/notify"
    start_str = t_start.strftime("%d/%m/%Y %H:%M") if isinstance(t_start, datetime) else str(t_start)
    end_str = t_end.strftime("%H:%M") if isinstance(t_end, datetime) else str(t_end)
    payload = {"id": booking_id, "resource": resource, "name": name, "dept": dept, "date": start_str, "end_date": end_str, "purpose": purpose, "destination": destination}
    try:
        requests.post(render_url, json=payload, timeout=15)
        st.toast("üîî ‡∏™‡πà‡∏á‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤ LINE ‡πÅ‡∏•‡πâ‡∏ß", icon="‚úÖ")
    except: pass

# --- 2. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ (‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏ß‡πâ 45 ‡∏ß‡∏±‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô) ---
def auto_delete_old_bookings():
    threshold_delete = (datetime.now() - timedelta(days=45)).isoformat()
    try:
        supabase.table("bookings").delete().lt("end_time", threshold_delete).execute()
    except: pass

# --- 3. ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡πÅ‡∏•‡∏∞ Sidebar ---
st.set_page_config(page_title="‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏≠‡∏á‡∏£‡∏ñ & ‡∏´‡πâ‡∏≠‡∏á‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°", layout="wide")
st.markdown("""
    <style>
    .stTextInput input, .stTextArea textarea, .stSelectbox div[data-baseweb="select"] {
        background-color: #E3F2FD !important; color: #0D47A1 !important; border: 1px solid #BBDEFB !important;
    }
    </style>
""", unsafe_allow_html=True)

LOGO_URL = "https://lh3.googleusercontent.com/d/1zCjSjSbCO-mbsaGoDI6g0G-bfmyVfqFV"
st.sidebar.image(LOGO_URL, use_container_width=True)
st.sidebar.markdown("---")

auto_delete_old_bookings()

st.title("‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏≠‡∏á‡∏£‡∏ñ‡∏¢‡∏ô‡∏ï‡πå‡πÅ‡∏•‡∏∞‡∏´‡πâ‡∏≠‡∏á‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏° Online")
menu = ["üìù ‡∏à‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà", "üìÖ ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏á‡∏≤‡∏ô (Real-time)", "üîë Admin (‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥)", "üìä ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡πÄ‡∏î‡∏∑‡∏≠‡∏ô"]
choice = st.sidebar.selectbox("‡πÄ‡∏°‡∏ô‡∏π", menu)

# --- ‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà ---
if choice == "üìù ‡∏à‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà":
    st.subheader("‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á")
    col1, col2 = st.columns(2)
    with col1:
        cat = st.radio("‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏ó‡∏£‡∏±‡∏û‡∏¢‡∏≤‡∏Å‡∏£", ["‡∏£‡∏ñ‡∏¢‡∏ô‡∏ï‡πå", "‡∏´‡πâ‡∏≠‡∏á‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°"])
        res = st.selectbox("‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£", ["Civic (‡∏ï‡∏∏‡πâ‡∏°)", "Civic (‡∏ö‡∏≠‡∏•)", "Camry (‡πÄ‡∏ô‡∏Å)", "MG ‡∏Ç‡∏±‡∏ö‡πÄ‡∏≠‡∏á"] if cat == "‡∏£‡∏ñ‡∏¢‡∏ô‡∏ï‡πå" else ["‡∏´‡πâ‡∏≠‡∏á‡∏ä‡∏±‡πâ‡∏ô 1", "‡∏´‡πâ‡∏≠‡∏á VIP", "‡∏´‡πâ‡∏≠‡∏á‡∏ä‡∏±‡πâ‡∏ô 2"])
        dest = st.text_input("‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á") if cat == "‡∏£‡∏ñ‡∏¢‡∏ô‡∏ï‡πå" else "Office"
        if cat == "‡∏£‡∏ñ‡∏¢‡∏ô‡∏ï‡πå":
            if dest:
                st.link_button(f"üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ '{dest}' ‡∏ö‡∏ô‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà", f"https://www.google.com/maps/search/{dest}")
            else:
                st.link_button("üìç ‡πÄ‡∏õ‡∏¥‡∏î Google Maps", "https://www.google.com/maps")
        name = st.text_input("‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏à‡∏≠‡∏á")
        phone = st.text_input("‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå")
        dept = st.text_input("‡πÅ‡∏ú‡∏ô‡∏Å")
    with col2:
        d_start = st.date_input("‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°", datetime.now().date())
        t_start_raw = st.text_input("‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏° (‡∏û‡∏¥‡∏°‡∏û‡πå 4 ‡∏´‡∏•‡∏±‡∏Å ‡πÄ‡∏ä‡πà‡∏ô 0800)", value="0800", max_chars=4)
        st.markdown("---")
        d_end = st.date_input("‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î", value=d_start, min_value=d_start)
        t_end_raw = st.text_input("‡πÄ‡∏ß‡∏•‡∏≤‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î (‡∏û‡∏¥‡∏°‡∏û‡πå 4 ‡∏´‡∏•‡∏±‡∏Å ‡πÄ‡∏ä‡πà‡∏ô 1700)", value="1700", max_chars=4)
        reason = st.text_area("‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏õ‡∏£‡∏∞‡∏™‡∏á‡∏Ñ‡πå")
        try:
            ts_f = format_time_string(t_start_raw); te_f = format_time_string(t_end_raw)
            t_start = datetime.combine(d_start, datetime.strptime(ts_f, "%H:%M").time())
            t_end = datetime.combine(d_end, datetime.strptime(te_f, "%H:%M").time())
        except: t_start, t_end = None, None

    # ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà 1: ‡∏Å‡∏≤‡∏£‡πÄ‡∏¢‡∏∑‡πâ‡∏≠‡∏á (Indentation) ‡∏Ç‡∏≠‡∏á‡∏õ‡∏∏‡πà‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
    if st.button("‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏à‡∏≠‡∏á"):
        if not name or not dept or t_start is None: st.warning("‚ö†Ô∏è ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö")
        elif t_start >= t_end: st.error("‚ùå ‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏ß‡∏•‡∏≤‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î")
        else:
            data = {"resource": res, "requester": name, "phone": phone, "dept": dept, "start_time": t_start.isoformat(), "end_time": t_end.isoformat(), "purpose": reason, "destination": dest, "status": "Pending"}
            resp = supabase.table("bookings").insert(data).execute()
            if resp.data:
                send_line_notification(resp.data[0]['id'], res, name, dept, t_start, t_end, reason, dest)
                st.success("‚úÖ ‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!")

# --- ‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏á‡∏≤‡∏ô (Real-time) ---
elif choice == "üìÖ ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏á‡∏≤‡∏ô (Real-time)":
    st.subheader("üìÖ ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏á‡∏≤‡∏ô‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô (‡πÅ‡∏™‡∏î‡∏á‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á 24 ‡∏ä‡∏°.)")
    # üí° ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà 2: ‡πÉ‡∏ä‡πâ errors='coerce' ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡∏™‡∏µ‡πÅ‡∏î‡∏á ValueError
    threshold_show = (datetime.now() - timedelta(hours=24)).isoformat()
    res_db = supabase.table("bookings").select("*").eq("status", "Approved").gt("end_time", threshold_show).order("start_time").execute()
    df = pd.DataFrame(res_db.data)
    
    if df.empty: st.info("‡∏Ç‡∏ì‡∏∞‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á")
    else:
        df['start_fmt'] = pd.to_datetime(df['start_time'], errors='coerce').dt.strftime('%d/%m/%Y %H:%M')
        df['end_fmt'] = pd.to_datetime(df['end_time'], errors='coerce').dt.strftime('%d/%m/%Y %H:%M')
        st.dataframe(df[['resource', 'start_fmt', 'end_fmt', 'requester', 'purpose', 'destination']], use_container_width=True)

# --- ‡∏´‡∏ô‡πâ‡∏≤ Admin (‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥) ---
elif choice == "üîë Admin (‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥)":
    st.subheader("üîë ‡∏£‡∏∞‡∏ö‡∏ö‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á")
    pw = st.text_input("‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô Admin", type="password")
    if pw == "s1234":
        items = supabase.table("bookings").select("*").eq("status", "Pending").order("id").execute().data
        if not items: st.info("‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥")
        else:
            for item in items:
                with st.container(border=True):
                    col1, col2 = st.columns([4, 1])
                    with col1:
                        c_s = pd.to_datetime(item['start_time'], errors='coerce')
                        a_d = st.date_input("‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà", c_s.date() if pd.notnull(c_s) else datetime.now().date(), key=f"d_{item['id']}")
                        a_t = st.text_input("‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏° (4 ‡∏´‡∏•‡∏±‡∏Å)", c_s.strftime("%H%M") if pd.notnull(c_s) else "0800", key=f"t_{item['id']}", max_chars=4)
                        st.write(f"üöó {item['resource']} | üë§ {item['requester']} | üìç {item.get('destination','-')}")
                    if col2.button("‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥ ‚úÖ", key=f"app_{item['id']}"):
                        try:
                            f_t = format_time_string(a_t)
                            final_t = datetime.combine(a_d, datetime.strptime(f_t, "%H:%M").time()).isoformat()
                            supabase.table("bookings").update({"status": "Approved", "start_time": final_t}).eq("id", item['id']).execute()
                            st.rerun()
                        except: st.error("‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÄ‡∏ß‡∏•‡∏≤‡∏ú‡∏¥‡∏î")

# --- ‡∏´‡∏ô‡πâ‡∏≤‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡πÄ‡∏î‡∏∑‡∏≠‡∏ô ---
elif choice == "üìä ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡πÄ‡∏î‡∏∑‡∏≠‡∏ô":
    st.subheader("üìä ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô (‡πÄ‡∏Å‡πá‡∏ö‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á 45 ‡∏ß‡∏±‡∏ô)")
    admin_pw = st.text_input("‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô", type="password")
    if admin_pw == "s1234":
        cars = ["Civic (‡∏ï‡∏∏‡πâ‡∏°)", "Civic (‡∏ö‡∏≠‡∏•)", "Camry (‡πÄ‡∏ô‡∏Å)", "MG ‡∏Ç‡∏±‡∏ö‡πÄ‡∏≠‡∏á"]
        res_rep = supabase.table("bookings").select("*").in_("resource", cars).eq("status", "Approved").execute()
        if res_rep.data:
            df_rep = pd.DataFrame(res_rep.data)
            df_rep['start_time'] = pd.to_datetime(df_rep['start_time'], errors='coerce')
            df_rep['Month-Year'] = df_rep['start_time'].dt.strftime('%m/%Y')
            sel_m = st.selectbox("‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏î‡∏∑‡∏≠‡∏ô", df_rep['Month-Year'].unique())
            final_df = df_rep[df_rep['Month-Year'] == sel_m].copy()
            st.dataframe(final_df[['resource', 'requester', 'dept', 'start_time', 'destination', 'purpose']], use_container_width=True)
            
            # üí° ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà 3: ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô ModuleNotFoundError
            buffer = io.BytesIO()
            try:
                with pd.ExcelWriter(buffer, engine='xlsxwriter') as writer:
                    final_df.to_excel(writer, index=False)
                st.download_button("üì• Download Excel", buffer.getvalue(), f"Car_Report_{sel_m}.xlsx")
            except:
                # ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏•‡∏á xlsxwriter ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ CSV ‡πÅ‡∏ó‡∏ô‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡πÄ‡∏ß‡πá‡∏ö‡∏Ñ‡πâ‡∏≤‡∏á
                st.download_button("üì• Download CSV (‡∏™‡∏≥‡∏£‡∏≠‡∏á)", final_df.to_csv(index=False).encode('utf-8-sig'), "report.csv")
